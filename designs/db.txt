-- =========================
-- AFF Designer â€“ PostgreSQL ERD
-- =========================
-- Notes:
-- - UUID primary keys
-- - Timestamps in UTC
-- - Soft-deletes omitted for brevity (add deleted_at if needed)
-- - Adjust ON DELETE rules per your policy
-- - Uses enums for clarity; replace with CHECKs if preferred

-- ---------- Extensions ----------
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ---------- Enums ----------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_role') THEN
    CREATE TYPE user_role AS ENUM ('designer','tailor','both');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'project_status') THEN
    CREATE TYPE project_status AS ENUM ('open','in_progress','completed','cancelled');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'bid_status') THEN
    CREATE TYPE bid_status AS ENUM ('pending','accepted','rejected','withdrawn','expired');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'order_status') THEN
    CREATE TYPE order_status AS ENUM ('pending_payment','paid','in_delivery','delivered','approved','disputed','refunded','completed','cancelled');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'escrow_status') THEN
    CREATE TYPE escrow_status AS ENUM ('pending','held','released','refunded','disputed','failed');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_category') THEN
    CREATE TYPE notification_category AS ENUM ('auth','marketplace','payments','system','marketing');
  END IF;

  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_channel') THEN
    CREATE TYPE notification_channel AS ENUM ('in_app','email','push','sms');
  END IF;
END $$;

-- ---------- Users ----------
CREATE TABLE public.users (
  id                 UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email              CITEXT UNIQUE NOT NULL,
  password_hash      TEXT,                             -- null for SSO
  name               TEXT NOT NULL,
  role               user_role NOT NULL DEFAULT 'designer',
  bio                TEXT,
  avatar_url         TEXT,
  rating             NUMERIC(3,2) DEFAULT 0.00,        -- avg rating
  paystack_subacct   TEXT,                              -- seller payout config
  locale             TEXT DEFAULT 'en',
  marketing_opt_in   BOOLEAN NOT NULL DEFAULT FALSE,
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_users_role ON public.users(role);

-- ---------- Designs (parametric JSON + exports) ----------
CREATE TABLE public.designs (
  id             UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id        UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  title          TEXT NOT NULL,
  garment_type   TEXT NOT NULL,                         -- e.g. shirt|skirt|trousers
  pattern_data   JSONB NOT NULL,                        -- parametric schema
  fabric_texture TEXT,                                  -- url/id of swatch
  export_png_url TEXT,
  export_svg_url TEXT,
  export_json_url TEXT,
  is_public      BOOLEAN NOT NULL DEFAULT FALSE,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_designs_user ON public.designs(user_id);
CREATE INDEX idx_designs_garment ON public.designs(garment_type);
CREATE INDEX idx_designs_public ON public.designs(is_public);

-- ---------- Projects (designer posts job) ----------
CREATE TABLE public.projects (
  id             UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  designer_id    UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  design_id      UUID REFERENCES public.designs(id) ON DELETE SET NULL,
  title          TEXT NOT NULL,
  description    TEXT,
  budget_cents   BIGINT NOT NULL,                       -- store money in minor units
  status         project_status NOT NULL DEFAULT 'open',
  deadline       TIMESTAMPTZ,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_projects_designer ON public.projects(designer_id);
CREATE INDEX idx_projects_status ON public.projects(status);

-- Optional: pre-payment requirements agreement
CREATE TABLE public.project_requirements (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id   UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  content      JSONB NOT NULL,                          -- structured requirements
  designer_approved BOOLEAN NOT NULL DEFAULT FALSE,
  tailor_approved   BOOLEAN NOT NULL DEFAULT FALSE,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ---------- Bids (tailor -> project) ----------
CREATE TABLE public.bids (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id   UUID NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  tailor_id    UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  amount_cents BIGINT NOT NULL,
  duration_text TEXT,                                   -- e.g., "7 days"
  message      TEXT,
  status       bid_status NOT NULL DEFAULT 'pending',
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (project_id, tailor_id)                        -- one active bid per tailor
);

CREATE INDEX idx_bids_project ON public.bids(project_id);
CREATE INDEX idx_bids_tailor ON public.bids(tailor_id);
CREATE INDEX idx_bids_status ON public.bids(status);

-- ---------- Orders (created when a bid is accepted) ----------
CREATE TABLE public.orders (
  id             UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  buyer_id       UUID NOT NULL REFERENCES public.users(id) ON DELETE RESTRICT,  -- designer
  seller_id      UUID NOT NULL REFERENCES public.users(id) ON DELETE RESTRICT,  -- tailor
  bid_id         UUID UNIQUE REFERENCES public.bids(id) ON DELETE SET NULL,
  project_id     UUID NOT NULL REFERENCES public.projects(id) ON DELETE RESTRICT,
  amount_cents   BIGINT NOT NULL,
  commission_bps INTEGER NOT NULL DEFAULT 1000,          -- e.g., 1000 = 10.00%
  status         order_status NOT NULL DEFAULT 'pending_payment',
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_orders_buyer ON public.orders(buyer_id);
CREATE INDEX idx_orders_seller ON public.orders(seller_id);
CREATE INDEX idx_orders_project ON public.orders(project_id);
CREATE INDEX idx_orders_status ON public.orders(status);

-- Deliveries & files (tailor -> buyer)
CREATE TABLE public.order_deliveries (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_id     UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  note         TEXT,
  files        JSONB,                                   -- list of URLs/metadata
  created_by   UUID NOT NULL REFERENCES public.users(id) ON DELETE RESTRICT,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ---------- Escrow Transactions (wallet-less) ----------
CREATE TABLE public.escrow_transactions (
  id             UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_id       UUID NOT NULL UNIQUE REFERENCES public.orders(id) ON DELETE CASCADE,
  gateway        TEXT NOT NULL,                          -- paystack|stripe|flutterwave
  amount_cents   BIGINT NOT NULL,
  commission_cents BIGINT NOT NULL,
  escrow_status  escrow_status NOT NULL DEFAULT 'pending',
  payment_ref    TEXT,                                   -- gateway reference
  released_at    TIMESTAMPTZ,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ---------- Messaging ----------
CREATE TABLE public.message_threads (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id   UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- thread participants (N:M)
CREATE TABLE public.thread_participants (
  thread_id   UUID NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
  user_id     UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  role_hint   user_role,                                 -- optional
  PRIMARY KEY (thread_id, user_id)
);

CREATE TABLE public.messages (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  thread_id    UUID NOT NULL REFERENCES public.message_threads(id) ON DELETE CASCADE,
  sender_id    UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  content      TEXT,
  attachments  JSONB,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_messages_thread ON public.messages(thread_id);
CREATE INDEX idx_messages_sender ON public.messages(sender_id);

-- ---------- Notifications & Preferences ----------
CREATE TABLE public.notifications (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id      UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  type         TEXT NOT NULL,                             -- e.g., bid.created
  title        TEXT NOT NULL,
  body         TEXT,
  data         JSONB,                                     -- deep links/ids
  read_at      TIMESTAMPTZ,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON public.notifications(user_id);
CREATE INDEX idx_notifications_unread ON public.notifications(user_id, read_at);

CREATE TABLE public.user_notification_preferences (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id      UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  category     notification_category NOT NULL,
  channel      notification_channel NOT NULL,
  enabled      BOOLEAN NOT NULL DEFAULT TRUE,
  digest       TEXT DEFAULT 'none',                       -- none|daily|weekly
  UNIQUE (user_id, category, channel)
);

-- ---------- Reviews (after order completion) ----------
CREATE TABLE public.reviews (
  id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_id      UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  reviewer_id   UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  reviewed_id   UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  rating        INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5),
  comment       TEXT,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (order_id, reviewer_id)
);

CREATE INDEX idx_reviews_reviewed ON public.reviews(reviewed_id);

-- ---------- Marketplace Products (ready-made items) ----------
CREATE TABLE public.products (
  id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  seller_id     UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  title         TEXT NOT NULL,
  description   TEXT,
  price_cents   BIGINT NOT NULL,
  stock         INTEGER NOT NULL DEFAULT 0,
  category      TEXT,
  images        JSONB,                                    -- array of urls
  is_active     BOOLEAN NOT NULL DEFAULT TRUE,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_products_seller ON public.products(seller_id);
CREATE INDEX idx_products_active ON public.products(is_active);

-- ---------- Orders for Products (non-escrow by default) ----------
CREATE TABLE public.product_orders (
  id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  buyer_id      UUID NOT NULL REFERENCES public.users(id) ON DELETE RESTRICT,
  seller_id     UUID NOT NULL REFERENCES public.users(id) ON DELETE RESTRICT,
  product_id    UUID NOT NULL REFERENCES public.products(id) ON DELETE RESTRICT,
  quantity      INTEGER NOT NULL CHECK (quantity > 0),
  amount_cents  BIGINT NOT NULL,
  payment_ref   TEXT,
  status        TEXT NOT NULL DEFAULT 'pending_payment', -- simple flow
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_product_orders_buyer ON public.product_orders(buyer_id);
CREATE INDEX idx_product_orders_seller ON public.product_orders(seller_id);
CREATE INDEX idx_product_orders_product ON public.product_orders(product_id);

-- ---------- Audit / Outbox (optional but recommended) ----------
CREATE TABLE public.outbox_events (
  id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  aggregate     TEXT NOT NULL,                           -- e.g., "Order:ORD_123"
  event_name    TEXT NOT NULL,                           -- e.g., "order.paid"
  payload       JSONB NOT NULL,
  status        TEXT NOT NULL DEFAULT 'pending',         -- pending|dispatched|failed
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_outbox_status ON public.outbox_events(status);

-- ---------- Triggers (updated_at) ----------
CREATE OR REPLACE FUNCTION set_updated_at() RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = NOW(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_projects_updated
BEFORE UPDATE ON public.projects FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE TRIGGER trg_bids_updated
BEFORE UPDATE ON public.bids FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE TRIGGER trg_orders_updated
BEFORE UPDATE ON public.orders FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE TRIGGER trg_designs_updated
BEFORE UPDATE ON public.designs FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE TRIGGER trg_products_updated
BEFORE UPDATE ON public.products FOR EACH ROW EXECUTE FUNCTION set_updated_at();
CREATE TRIGGER trg_escrow_updated
BEFORE UPDATE ON public.escrow_transactions FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- End of schema
-- =========================
